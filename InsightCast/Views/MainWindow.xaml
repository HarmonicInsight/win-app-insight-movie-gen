<Window x:Class="InsightCast.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:InsightCast.Converters"
        xmlns:shell="clr-namespace:System.Windows.Shell;assembly=PresentationFramework"
        Title="{Binding WindowTitle}"
        MinWidth="1100" MinHeight="750"
        Width="1300" Height="950"
        WindowStartupLocation="CenterScreen"
        PreviewKeyDown="Window_PreviewKeyDown"
        Closing="Window_Closing"
        StateChanged="Window_StateChanged">

    <shell:WindowChrome.WindowChrome>
        <shell:WindowChrome CaptionHeight="40"
                            ResizeBorderThickness="4"
                            GlassFrameThickness="0"
                            CornerRadius="0"
                            UseAeroCaptionButtons="False"/>
    </shell:WindowChrome.WindowChrome>

    <Window.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <conv:InverseBoolConverter x:Key="InverseBool"/>
    </Window.Resources>

    <Window.CommandBindings>
        <CommandBinding Command="ApplicationCommands.New" Executed="NewProject_Executed"/>
        <CommandBinding Command="ApplicationCommands.Open" Executed="OpenProject_Executed"/>
        <CommandBinding Command="ApplicationCommands.Save" Executed="SaveProject_Executed"/>
    </Window.CommandBindings>

    <Window.InputBindings>
        <KeyBinding Key="N" Modifiers="Control" Command="ApplicationCommands.New"/>
        <KeyBinding Key="O" Modifiers="Control" Command="ApplicationCommands.Open"/>
        <KeyBinding Key="S" Modifiers="Control" Command="ApplicationCommands.Save"/>
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ================================================================ -->
        <!-- A) Header / Custom Title Bar (Simplified)                        -->
        <!-- ================================================================ -->
        <Border Grid.Row="0" Background="{DynamicResource TitlebarBg}"
                BorderBrush="{DynamicResource BorderDefault}" BorderThickness="0,0,0,1">
            <DockPanel>
                <!-- Right: Window control buttons -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Top">
                    <Button x:Name="MinimizeButton" Click="MinimizeButton_Click"
                            Width="46" Height="32" BorderThickness="0" Background="Transparent"
                            shell:WindowChrome.IsHitTestVisibleInChrome="True"
                            ToolTip="{DynamicResource Window.Minimize}">
                        <Path Data="M0,0 H10" Stroke="{DynamicResource TextPrimary}" StrokeThickness="1"/>
                    </Button>
                    <Button x:Name="MaximizeButton" Click="MaximizeButton_Click"
                            Width="46" Height="32" BorderThickness="0" Background="Transparent"
                            shell:WindowChrome.IsHitTestVisibleInChrome="True"
                            ToolTip="{DynamicResource Window.Maximize}">
                        <Path x:Name="MaximizeIcon" Data="M0,0 H10 V10 H0 Z" Stroke="{DynamicResource TextPrimary}" StrokeThickness="1"/>
                    </Button>
                    <Button x:Name="CloseButton" Click="CloseButton_Click"
                            Width="46" Height="32" BorderThickness="0" Background="Transparent"
                            shell:WindowChrome.IsHitTestVisibleInChrome="True"
                            ToolTip="{DynamicResource Window.Close}">
                        <Path Data="M0,0 L10,10 M0,10 L10,0" Stroke="{DynamicResource TextPrimary}" StrokeThickness="1"/>
                    </Button>
                </StackPanel>

                <DockPanel Margin="10,6,0,6">
                    <!-- Left: App title -->
                    <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="InsightCast" FontSize="18" FontWeight="Bold"
                                   Foreground="{DynamicResource TitlebarFg}" VerticalAlignment="Center"/>
                        <TextBlock x:Name="VersionLabel" Text="v1.0.0" Foreground="{DynamicResource TitlebarSecondary}"
                                   FontSize="11" VerticalAlignment="Bottom" Margin="8,0,0,4"/>
                    </StackPanel>

                    <!-- Right: Mode toggle + Lang + License + Status -->
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                        <!-- Mode Toggle -->
                        <Border Background="{DynamicResource BgSecondary}" CornerRadius="12"
                                Padding="2" Margin="0,0,8,0" VerticalAlignment="Center"
                                BorderBrush="{DynamicResource BorderDefault}" BorderThickness="1"
                                shell:WindowChrome.IsHitTestVisibleInChrome="True">
                            <StackPanel Orientation="Horizontal">
                                <RadioButton Content="{DynamicResource Mode.Simple}"
                                             IsChecked="{Binding IsSimpleMode}"
                                             GroupName="UIMode" Cursor="Hand">
                                    <RadioButton.Template>
                                        <ControlTemplate TargetType="RadioButton">
                                            <Border x:Name="border" Background="Transparent" CornerRadius="10" Padding="10,4">
                                                <TextBlock x:Name="text" Text="{TemplateBinding Content}"
                                                           FontSize="11" FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextSecondary}"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsChecked" Value="True">
                                                    <Setter TargetName="border" Property="Background" Value="{DynamicResource BrandPrimary}"/>
                                                    <Setter TargetName="text" Property="Foreground" Value="White"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </RadioButton.Template>
                                </RadioButton>
                                <RadioButton Content="{DynamicResource Mode.Detail}"
                                             IsChecked="{Binding IsSimpleMode, Converter={StaticResource InverseBool}}"
                                             GroupName="UIMode" Cursor="Hand">
                                    <RadioButton.Template>
                                        <ControlTemplate TargetType="RadioButton">
                                            <Border x:Name="border" Background="Transparent" CornerRadius="10" Padding="10,4">
                                                <TextBlock x:Name="text" Text="{TemplateBinding Content}"
                                                           FontSize="11" FontWeight="SemiBold"
                                                           Foreground="{DynamicResource TextSecondary}"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsChecked" Value="True">
                                                    <Setter TargetName="border" Property="Background" Value="{DynamicResource BrandPrimary}"/>
                                                    <Setter TargetName="text" Property="Foreground" Value="White"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </RadioButton.Template>
                                </RadioButton>
                            </StackPanel>
                        </Border>

                        <Button Padding="6,3" Margin="2" FontSize="11"
                                Background="{DynamicResource BgPrimary}" Foreground="{DynamicResource TextPrimary}"
                                BorderBrush="{DynamicResource BorderDark}"
                                x:Name="LangSwitchButton" Click="LangSwitchButton_Click"
                                shell:WindowChrome.IsHitTestVisibleInChrome="True">
                            <TextBlock Text="{DynamicResource Lang.SwitchTo}" VerticalAlignment="Center"/>
                        </Button>
                        <Button Padding="6,3" Margin="2" FontSize="11"
                                Background="{DynamicResource BgPrimary}" Foreground="{DynamicResource TextPrimary}"
                                BorderBrush="{DynamicResource BorderDark}"
                                Command="{Binding ShowLicenseManagerCommand}"
                                shell:WindowChrome.IsHitTestVisibleInChrome="True">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="M6,0 L12,3 V7 L6,12 L0,7 V3 Z"
                                      Stroke="{DynamicResource TextPrimary}" StrokeThickness="1"
                                      VerticalAlignment="Center" Margin="0,0,4,0"/>
                                <TextBlock Text="{DynamicResource Header.LicenseManager}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        <Border Background="{DynamicResource BgSecondary}" CornerRadius="3"
                                Padding="8,3" Margin="4,0,0,0" VerticalAlignment="Center"
                                BorderBrush="{DynamicResource BorderDefault}" BorderThickness="1">
                            <TextBlock Text="{Binding StatusText}"
                                       Foreground="{DynamicResource TextSecondary}" FontSize="11"/>
                        </Border>
                    </StackPanel>

                    <!-- Spacer -->
                    <Border/>
                </DockPanel>
            </DockPanel>
        </Border>

        <!-- ================================================================ -->
        <!-- B) Menu Bar (Always visible)                                      -->
        <!-- ================================================================ -->
        <Menu Grid.Row="1"
              Background="{DynamicResource TitlebarBg}"
              Foreground="{DynamicResource TextPrimary}"
              Padding="6,2">
            <MenuItem Header="{DynamicResource Menu.File}">
                <MenuItem Header="{DynamicResource Menu.File.New}" InputGestureText="Ctrl+N"
                          Command="{Binding NewProjectCommand}"/>
                <MenuItem Header="{DynamicResource Menu.File.Open}" InputGestureText="Ctrl+O"
                          Command="{Binding OpenProjectCommand}"/>
                <MenuItem Header="{DynamicResource Menu.File.Recent}" x:Name="RecentFilesMenu"
                          SubmenuOpened="RecentFilesMenu_SubmenuOpened"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu.File.Save}" InputGestureText="Ctrl+S"
                          Command="{Binding SaveProjectCommand}"/>
                <MenuItem Header="{DynamicResource Menu.File.SaveAs}" InputGestureText="Ctrl+Shift+S"
                          Command="{Binding SaveProjectAsCommand}"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Header.ImportPptx}"
                          Command="{Binding ImportPptxCommand}"
                          IsEnabled="{Binding CanPptx}"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu.File.Exit}" InputGestureText="Alt+F4"
                          Command="{Binding ExitCommand}"/>
            </MenuItem>

            <MenuItem Header="{DynamicResource Menu.Edit}">
                <MenuItem Header="{DynamicResource Menu.Edit.AddScene}" InputGestureText="Ctrl+T"
                          Command="{Binding AddSceneCommand}"/>
                <MenuItem Header="{DynamicResource Menu.Edit.RemoveScene}" InputGestureText="Delete"
                          Command="{Binding RemoveSceneCommand}"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu.Edit.MoveUp}" InputGestureText="Ctrl+Up"
                          Command="{Binding MoveSceneUpCommand}"/>
                <MenuItem Header="{DynamicResource Menu.Edit.MoveDown}" InputGestureText="Ctrl+Down"
                          Command="{Binding MoveSceneDownCommand}"/>
            </MenuItem>

            <MenuItem Header="{DynamicResource Menu.Help}">
                <MenuItem Header="{DynamicResource Menu.Help.Tutorial}" InputGestureText="F1"
                          Command="{Binding ShowTutorialCommand}"/>
                <MenuItem Header="{DynamicResource Menu.Help.FAQ}"
                          Command="{Binding ShowFaqCommand}"/>
                <MenuItem Header="{DynamicResource Menu.Help.Shortcuts}"
                          Command="{Binding ShowShortcutsCommand}"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu.Help.License}"
                          Command="{Binding ShowLicenseManagerCommand}"/>
                <MenuItem Header="{DynamicResource Menu.Help.LicenseInfo}"
                          Command="{Binding ShowLicenseInfoCommand}"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu.Help.Terms}"
                          Command="{Binding ShowTermsCommand}"/>
                <MenuItem Header="{DynamicResource Menu.Help.Privacy}"
                          Command="{Binding ShowPrivacyCommand}"/>
                <Separator/>
                <MenuItem Header="{DynamicResource Menu.Help.About}"
                          Command="{Binding ShowAboutCommand}"/>
            </MenuItem>
        </Menu>

        <!-- ================================================================ -->
        <!-- C) Main Content                                                   -->
        <!-- ================================================================ -->
        <Grid Grid.Row="2" Margin="4,4,4,2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="180" MinWidth="140" MaxWidth="300"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Scene List -->
            <GroupBox Grid.Column="0" Header="{DynamicResource Scene.List}" Padding="4">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal"
                                HorizontalAlignment="Center" Margin="0,4,0,0">
                        <Button Content="{DynamicResource Common.Add}" Padding="4,2" Margin="1"
                                Command="{Binding AddSceneCommand}"/>
                        <Button Content="{DynamicResource Common.Remove}" Padding="4,2" Margin="1"
                                Command="{Binding RemoveSceneCommand}"/>
                        <Button Content="↑" Padding="6,2" Margin="1"
                                Command="{Binding MoveSceneUpCommand}"/>
                        <Button Content="↓" Padding="6,2" Margin="1"
                                Command="{Binding MoveSceneDownCommand}"/>
                    </StackPanel>
                    <ListBox x:Name="SceneListBox"
                             ItemsSource="{Binding SceneItems}"
                             SelectedIndex="{Binding SelectedSceneIndex}"
                             HorizontalContentAlignment="Stretch">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Label}"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </GroupBox>

            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch"
                          Background="{DynamicResource BorderDefault}"/>

            <!-- Right Panel: Scene Editor -->
            <GroupBox Grid.Column="2" Header="{DynamicResource Scene.Editor}" Padding="4">
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="8">

                        <!-- Media info -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="{DynamicResource Scene.Media}" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBlock Text="{Binding MediaName}" VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondary}" MinWidth="120" Margin="0,0,8,0"/>
                            <Button Content="{DynamicResource Common.Select}" Padding="10,3" Margin="2"
                                    Command="{Binding SelectMediaCommand}"/>
                            <Button Content="{DynamicResource Common.Clear}" Padding="10,3" Margin="2"
                                    Command="{Binding ClearMediaCommand}"/>
                        </StackPanel>

                        <!-- Preview + Narration -->
                        <Grid Margin="0,0,0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Border Grid.Column="0" Width="120" Height="180"
                                    Background="#1a1a2e" CornerRadius="2" Margin="0,0,8,0" ClipToBounds="True">
                                <Grid>
                                    <Image x:Name="PreviewImage" Stretch="Uniform"/>
                                    <Border VerticalAlignment="Bottom" Background="#80000000" Padding="4,2">
                                        <TextBlock Text="{Binding SubtitleText}" Foreground="White"
                                                   FontSize="9" TextWrapping="Wrap" TextAlignment="Center" MaxWidth="112"/>
                                    </Border>
                                </Grid>
                            </Border>
                            <Grid Grid.Column="1">
                                <TextBox x:Name="NarrationTextBox"
                                         Text="{Binding NarrationText, UpdateSourceTrigger=PropertyChanged}"
                                         TextWrapping="Wrap" AcceptsReturn="True"
                                         VerticalScrollBarVisibility="Auto" MinHeight="140"
                                         VerticalContentAlignment="Top" Padding="4"/>
                                <TextBlock Text="{DynamicResource Scene.Narration.Placeholder}"
                                           Foreground="{DynamicResource TextPlaceholder}" FontStyle="Italic"
                                           IsHitTestVisible="False" Margin="8,6,0,0" VerticalAlignment="Top"
                                           Visibility="{Binding NarrationPlaceholderVisible, Converter={StaticResource BoolToVis}}"/>
                            </Grid>
                        </Grid>

                        <!-- Speaker + Audio controls -->
                        <WrapPanel Margin="0,0,0,4">
                            <TextBlock Text="{DynamicResource Scene.Speaker}" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <ComboBox MinWidth="180" Margin="0,0,12,0"
                                      ItemsSource="{Binding SceneSpeakers}"
                                      SelectedIndex="{Binding SelectedSceneSpeakerIndex}"
                                      DisplayMemberPath="DisplayName"/>
                            <CheckBox Content="{DynamicResource Scene.KeepAudio}"
                                      IsChecked="{Binding KeepOriginalAudio}"
                                      VerticalAlignment="Center" Margin="0,0,12,0"/>
                            <Button Content="{DynamicResource Scene.PreviewAudio}" Padding="8,3" Margin="2"
                                    Command="{Binding PreviewAudioCommand}"/>
                            <Button Content="{DynamicResource Scene.PreviewScene}" Padding="8,3" Margin="2"
                                    Command="{Binding PreviewSceneCommand}"/>
                            <Button Content="{DynamicResource Scene.Stop}" Padding="8,3" Margin="2"
                                    Command="{Binding StopPreviewCommand}"/>
                            <TextBlock Text="{DynamicResource Scene.SpeechSpeed}" VerticalAlignment="Center" Margin="12,0,4,0"/>
                            <ComboBox Width="90" ItemsSource="{Binding SpeechSpeedOptions}"
                                      SelectedIndex="{Binding SelectedSpeechSpeedIndex}"/>
                        </WrapPanel>

                        <!-- Subtitle -->
                        <StackPanel Margin="0,0,0,4">
                            <TextBlock Text="{DynamicResource Scene.Subtitle}" Margin="0,0,0,4"/>
                            <Grid>
                                <TextBox Text="{Binding SubtitleText, UpdateSourceTrigger=PropertyChanged}"
                                         Padding="4" MinHeight="50" MaxHeight="100"
                                         TextWrapping="Wrap" AcceptsReturn="True"
                                         VerticalScrollBarVisibility="Auto"
                                         VerticalContentAlignment="Top"
                                         IsEnabled="{Binding CanSubtitle}"/>
                                <TextBlock Text="{Binding SubtitlePlaceholder}"
                                           Foreground="{DynamicResource TextPlaceholder}" FontStyle="Italic"
                                           IsHitTestVisible="False" Margin="8,6,0,0" VerticalAlignment="Top"
                                           Visibility="{Binding SubtitlePlaceholderVisible, Converter={StaticResource BoolToVis}}"/>
                            </Grid>
                        </StackPanel>

                        <!-- Detail mode only sections -->
                        <!-- Subtitle style -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4"
                                    Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{DynamicResource Scene.SubtitleStyle}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <Border BorderBrush="{DynamicResource BorderDefault}" BorderThickness="1"
                                    CornerRadius="2" Padding="8,2" Margin="0,0,8,0" Background="#1a1a2e" MinWidth="40">
                                <TextBlock x:Name="StylePreviewLabel" Text="A" FontSize="16" FontWeight="Bold"
                                           Foreground="White" HorizontalAlignment="Center"/>
                            </Border>
                            <Button Content="{DynamicResource Scene.SubtitleStyle.Select}" Padding="10,3" Margin="2"
                                    Command="{Binding OpenStyleDialogCommand}" IsEnabled="{Binding CanSubtitleStyle}"/>
                        </StackPanel>

                        <!-- Text Overlays -->
                        <StackPanel Margin="0,4,0,4" Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                            <DockPanel Margin="0,0,0,4">
                                <TextBlock Text="{DynamicResource Overlay.Title}" VerticalAlignment="Center" DockPanel.Dock="Left"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="{DynamicResource Common.Add}" Padding="6,2" Margin="2"
                                            Command="{Binding AddOverlayCommand}"/>
                                    <Button Content="{DynamicResource Overlay.CoverTemplate}" Padding="6,2" Margin="2"
                                            Command="{Binding AddCoverTemplateCommand}"/>
                                    <Button Content="{DynamicResource Common.Remove}" Padding="6,2" Margin="2"
                                            Command="{Binding RemoveOverlayCommand}"/>
                                </StackPanel>
                            </DockPanel>
                            <ListBox ItemsSource="{Binding OverlayItems}" SelectedIndex="{Binding SelectedOverlayIndex}"
                                     Height="60" HorizontalContentAlignment="Stretch"
                                     Visibility="{Binding OverlayListVisible, Converter={StaticResource BoolToVis}}">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding DisplayLabel}" FontSize="11"/>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                            <Border BorderBrush="{DynamicResource BorderDefault}" BorderThickness="1"
                                    CornerRadius="3" Padding="8,6" Margin="0,4,0,0"
                                    Visibility="{Binding OverlayEditorVisible, Converter={StaticResource BoolToVis}}">
                                <StackPanel>
                                    <TextBlock Text="{DynamicResource Overlay.Text}" FontSize="11" Margin="0,0,0,2"/>
                                    <TextBox Text="{Binding OverlayText, UpdateSourceTrigger=PropertyChanged}"
                                             Padding="4" Height="28" VerticalContentAlignment="Center"/>
                                    <Grid Margin="0,6,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0" Margin="0,0,4,0">
                                            <TextBlock Text="{DynamicResource Overlay.XPosition}" FontSize="11" Margin="0,0,0,2"/>
                                            <TextBox Text="{Binding OverlayXPercent, UpdateSourceTrigger=PropertyChanged}"
                                                     Width="80" HorizontalAlignment="Left" TextAlignment="Center"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="{DynamicResource Overlay.YPosition}" FontSize="11" Margin="0,0,0,2"/>
                                            <TextBox Text="{Binding OverlayYPercent, UpdateSourceTrigger=PropertyChanged}"
                                                     Width="80" HorizontalAlignment="Left" TextAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>
                                    <WrapPanel Margin="0,6,0,0">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,12,0">
                                            <TextBlock Text="{DynamicResource Overlay.FontSize}" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Text="{Binding OverlayFontSize, UpdateSourceTrigger=PropertyChanged}"
                                                     Width="50" TextAlignment="Center"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,12,0">
                                            <TextBlock Text="{DynamicResource Overlay.Alignment}" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <ComboBox Width="80" ItemsSource="{Binding AlignmentOptions}"
                                                      SelectedIndex="{Binding SelectedAlignmentIndex}"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,12,0">
                                            <TextBlock Text="{DynamicResource Overlay.Color}" FontSize="11" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <ComboBox Width="80" ItemsSource="{Binding OverlayColorOptions}"
                                                      SelectedIndex="{Binding SelectedOverlayColorIndex}"/>
                                        </StackPanel>
                                    </WrapPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Duration mode -->
                        <StackPanel Margin="0,0,0,4" Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{DynamicResource Duration.Title}" Margin="0,0,0,4"/>
                            <StackPanel Orientation="Horizontal">
                                <RadioButton Content="{DynamicResource Duration.Auto}" IsChecked="{Binding IsAutoDuration}"
                                             VerticalAlignment="Center" Margin="0,0,16,0" GroupName="DurationMode"/>
                                <RadioButton Content="{DynamicResource Duration.Fixed}" IsChecked="{Binding IsFixedDuration}"
                                             VerticalAlignment="Center" Margin="0,0,8,0" GroupName="DurationMode"/>
                                <TextBox Text="{Binding DurationSeconds, UpdateSourceTrigger=PropertyChanged}"
                                         Width="60" TextAlignment="Center" Margin="0,0,4,0" IsEnabled="{Binding IsFixedDuration}"/>
                                <TextBlock Text="{DynamicResource Duration.Range}" VerticalAlignment="Center"
                                           Foreground="{DynamicResource TextTertiary}" FontSize="11"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Transition -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4"
                                    Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{DynamicResource Transition.Title}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <ComboBox Width="160" Margin="0,0,12,0"
                                      ItemsSource="{Binding TransitionDisplayNames}"
                                      SelectedIndex="{Binding SelectedTransitionIndex}"
                                      IsEnabled="{Binding CanTransition}"/>
                            <TextBlock Text="{DynamicResource Transition.Duration}" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBox Text="{Binding TransitionDuration, UpdateSourceTrigger=PropertyChanged}"
                                     Width="60" TextAlignment="Center" Margin="0,0,4,0" IsEnabled="{Binding CanTransition}"/>
                            <TextBlock Text="{DynamicResource Transition.Range}" VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextTertiary}" FontSize="11"/>
                        </StackPanel>

                        <!-- Intro/Outro -->
                        <StackPanel Margin="0,4,0,4" Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{DynamicResource IntroOutro.Title}" Margin="0,0,0,4"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,8,0">
                                    <TextBlock Text="{DynamicResource IntroOutro.Intro}" VerticalAlignment="Center" Margin="0,0,4,0" FontSize="11"/>
                                    <TextBlock Text="{Binding IntroFileName}" VerticalAlignment="Center"
                                               Foreground="{DynamicResource TextSecondary}" FontSize="11"
                                               MinWidth="80" MaxWidth="140" TextTrimming="CharacterEllipsis" Margin="0,0,4,0"/>
                                    <Button Content="{DynamicResource Common.Select}" Padding="6,2" Margin="1"
                                            Command="{Binding SelectIntroCommand}" FontSize="11"/>
                                    <Button Content="✕" Padding="4,2" Margin="1"
                                            Command="{Binding ClearIntroCommand}" FontSize="11"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <TextBlock Text="{DynamicResource IntroOutro.Outro}" VerticalAlignment="Center" Margin="0,0,4,0" FontSize="11"/>
                                    <TextBlock Text="{Binding OutroFileName}" VerticalAlignment="Center"
                                               Foreground="{DynamicResource TextSecondary}" FontSize="11"
                                               MinWidth="80" MaxWidth="140" TextTrimming="CharacterEllipsis" Margin="0,0,4,0"/>
                                    <Button Content="{DynamicResource Common.Select}" Padding="6,2" Margin="1"
                                            Command="{Binding SelectOutroCommand}" FontSize="11"/>
                                    <Button Content="✕" Padding="4,2" Margin="1"
                                            Command="{Binding ClearOutroCommand}" FontSize="11"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>

                        <!-- Watermark -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4"
                                    Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{DynamicResource Watermark.Title}" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <TextBlock Text="{Binding WatermarkFileName}" VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondary}" FontSize="11"
                                       MinWidth="80" MaxWidth="140" TextTrimming="CharacterEllipsis" Margin="0,0,4,0"/>
                            <Button Content="{DynamicResource Common.Select}" Padding="6,2" Margin="1"
                                    Command="{Binding SelectWatermarkCommand}"/>
                            <Button Content="✕" Padding="4,2" Margin="1"
                                    Command="{Binding ClearWatermarkCommand}"/>
                            <TextBlock Text="{DynamicResource Watermark.Position}" VerticalAlignment="Center" Margin="12,0,4,0"/>
                            <ComboBox Width="80" ItemsSource="{Binding WatermarkPositionOptions}"
                                      SelectedIndex="{Binding SelectedWatermarkPosIndex}"/>
                        </StackPanel>

                        <!-- Template -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4"
                                    Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="{DynamicResource Template.Title}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <Button Content="{DynamicResource Common.Save}" Padding="8,3" Margin="2"
                                    Command="{Binding SaveTemplateCommand}"/>
                            <Button Content="{DynamicResource Common.Load}" Padding="8,3" Margin="2"
                                    Command="{Binding LoadTemplateCommand}"/>
                            <Button Content="{DynamicResource Template.OpenOutput}" Padding="8,3" Margin="12,2,2,2"
                                    Command="{Binding OpenOutputFolderCommand}"/>
                        </StackPanel>

                        <!-- Info label -->
                        <TextBlock Text="{DynamicResource Duration.Info}"
                                   TextWrapping="Wrap" Foreground="{DynamicResource TextTertiary}"
                                   FontSize="11" Margin="0,0,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </GroupBox>
        </Grid>

        <!-- ================================================================ -->
        <!-- D) Export Panel                                                   -->
        <!-- ================================================================ -->
        <GroupBox Grid.Row="3" Header="{DynamicResource Export.Settings}" Margin="4,2,4,2" Padding="4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <WrapPanel Grid.Column="0" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="{DynamicResource Export.Speaker}" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <ComboBox MinWidth="200"
                                  ItemsSource="{Binding ExportSpeakers}"
                                  SelectedIndex="{Binding SelectedExportSpeakerIndex}"
                                  DisplayMemberPath="DisplayName"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="{DynamicResource Export.Resolution}" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <ComboBox Width="180" SelectedIndex="{Binding SelectedResolutionIndex}">
                            <ComboBoxItem Content="{DynamicResource Export.Res.Portrait}" Tag="1080x1920"/>
                            <ComboBoxItem Content="{DynamicResource Export.Res.Landscape}" Tag="1920x1080"/>
                        </ComboBox>
                    </StackPanel>

                    <!-- FPS: Detail mode only -->
                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2"
                                Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="FPS:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBox Text="{Binding FpsText, UpdateSourceTrigger=PropertyChanged}"
                                 Width="50" TextAlignment="Center"/>
                    </StackPanel>

                    <!-- BGM: Detail mode only -->
                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2"
                                Visibility="{Binding IsDetailMode, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="{Binding BgmStatusText}" VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextTertiary}" Margin="0,0,6,0"/>
                        <Button Content="{DynamicResource Export.BGM.Settings}" Padding="8,3"
                                Command="{Binding BgmSettingsCommand}"/>
                    </StackPanel>
                </WrapPanel>

                <Button Grid.Column="1"
                        Content="{DynamicResource Export.Button}"
                        Width="150" Height="44"
                        FontSize="12" FontWeight="Bold"
                        Style="{DynamicResource PrimaryButton}"
                        Command="{Binding ExportVideoCommand}"/>
            </Grid>
        </GroupBox>

        <!-- ================================================================ -->
        <!-- E) ProgressBar                                                    -->
        <!-- ================================================================ -->
        <DockPanel Grid.Row="4" Margin="4,0,4,2"
                   Visibility="{Binding ExportProgressVisible, Converter={StaticResource BoolToVis}}">
            <Button DockPanel.Dock="Right" Content="{DynamicResource Export.Cancel}"
                    Padding="12,2" Margin="4,0,0,0"
                    Command="{Binding CancelExportCommand}"/>
            <ProgressBar Height="6" Minimum="0" Maximum="100"
                         Value="{Binding ExportProgressValue, Mode=OneWay}"/>
        </DockPanel>

        <!-- ================================================================ -->
        <!-- F) Log Area                                                       -->
        <!-- ================================================================ -->
        <DockPanel Grid.Row="5" Height="120" Margin="4,0,4,4">
            <TextBlock Text="{DynamicResource Export.Log}" DockPanel.Dock="Top" FontSize="11"
                       Foreground="{DynamicResource TextSecondary}" Margin="0,0,0,2"/>
            <TextBox x:Name="LogTextBox" IsReadOnly="True"
                     VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto"
                     TextWrapping="NoWrap" FontSize="11" FontFamily="Consolas, MS Gothic"
                     Background="{DynamicResource BgSecondary}"/>
        </DockPanel>

        <MediaElement x:Name="AudioPlayer" Grid.Row="0"
                      LoadedBehavior="Manual" UnloadedBehavior="Stop"
                      Visibility="Collapsed" MediaEnded="AudioPlayer_MediaEnded"/>
    </Grid>
</Window>
