<Window x:Class="InsightMovie.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:InsightMovie.Converters"
        Title="{Binding WindowTitle}"
        MinWidth="1100" MinHeight="750"
        Width="1300" Height="950"
        WindowStartupLocation="CenterScreen"
        PreviewKeyDown="Window_PreviewKeyDown"
        Closing="Window_Closing">

    <Window.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <conv:InverseBoolConverter x:Key="InverseBool"/>
    </Window.Resources>

    <!-- Command Bindings for standard commands -->
    <Window.CommandBindings>
        <CommandBinding Command="ApplicationCommands.New" Executed="NewProject_Executed"/>
        <CommandBinding Command="ApplicationCommands.Open" Executed="OpenProject_Executed"/>
        <CommandBinding Command="ApplicationCommands.Save" Executed="SaveProject_Executed"/>
    </Window.CommandBindings>

    <Window.InputBindings>
        <KeyBinding Key="N" Modifiers="Control" Command="ApplicationCommands.New"/>
        <KeyBinding Key="O" Modifiers="Control" Command="ApplicationCommands.Open"/>
        <KeyBinding Key="S" Modifiers="Control" Command="ApplicationCommands.Save"/>
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Row 0: Header bar -->
            <RowDefinition Height="Auto"/>  <!-- Row 1: Menu bar -->
            <RowDefinition Height="*"/>     <!-- Row 2: Main content -->
            <RowDefinition Height="Auto"/>  <!-- Row 3: Export panel -->
            <RowDefinition Height="Auto"/>  <!-- Row 4: ProgressBar -->
            <RowDefinition Height="Auto"/>  <!-- Row 5: Log area -->
        </Grid.RowDefinitions>

        <!-- ================================================================ -->
        <!-- A) Header Bar                                                    -->
        <!-- ================================================================ -->
        <Border Grid.Row="0" Background="{DynamicResource TitlebarBg}" Padding="10,6" BorderBrush="#3D3529" BorderThickness="0,0,0,1">
            <DockPanel>
                <!-- Left: App title -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="InsightMovie" FontSize="18" FontWeight="Bold"
                               Foreground="{DynamicResource TitlebarFg}" VerticalAlignment="Center"/>
                    <TextBlock Text="v1.0.0" Foreground="{DynamicResource TitlebarSecondary}" FontSize="11"
                               VerticalAlignment="Bottom" Margin="8,0,0,4"/>
                </StackPanel>

                <!-- Right: License + Status -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="ライセンス管理"
                            Padding="6,3" Margin="2"
                            FontSize="11"
                            Background="#5A4F3C" Foreground="{DynamicResource TitlebarFg}"
                            BorderBrush="#8A7D64"
                            Command="{Binding ShowLicenseManagerCommand}"/>
                    <Border Background="#3D3529" CornerRadius="3"
                            Padding="8,3" Margin="4,0,0,0" VerticalAlignment="Center">
                        <TextBlock Text="{Binding StatusText}"
                                   Foreground="{DynamicResource TitlebarSecondary}" FontSize="11"/>
                    </Border>
                </StackPanel>

                <!-- Center/Right: Action buttons -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right"
                            VerticalAlignment="Center" Margin="8,0">
                    <Button Content="新規"
                            Padding="10,4" Margin="2"
                            Background="#5A4F3C" Foreground="{DynamicResource TitlebarFg}"
                            BorderBrush="#8A7D64"
                            Command="{Binding NewProjectCommand}"/>
                    <Button Content="設定ファイルを開く"
                            Padding="10,4" Margin="2"
                            Background="#5A4F3C" Foreground="{DynamicResource TitlebarFg}"
                            BorderBrush="#8A7D64"
                            Command="{Binding OpenProjectCommand}"/>
                    <Button Content="設定を上書き保存"
                            Padding="10,4" Margin="2"
                            Background="#5A4F3C" Foreground="{DynamicResource TitlebarFg}"
                            BorderBrush="#8A7D64"
                            Command="{Binding SaveProjectCommand}"/>
                    <Button Content="設定を別名で保存"
                            Padding="10,4" Margin="2"
                            Background="#5A4F3C" Foreground="{DynamicResource TitlebarFg}"
                            BorderBrush="#8A7D64"
                            Command="{Binding SaveProjectAsCommand}"/>
                    <Button Content="PPTX取込"
                            Padding="10,4" Margin="2"
                            Style="{DynamicResource PrimaryButton}"
                            Command="{Binding ImportPptxCommand}"
                            IsEnabled="{Binding CanPptx}"/>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- ================================================================ -->
        <!-- B) Menu Bar                                                       -->
        <!-- ================================================================ -->
        <Menu Grid.Row="1">
            <!-- ファイル -->
            <MenuItem Header="ファイル(_F)">
                <MenuItem Header="新規(_N)" InputGestureText="Ctrl+N"
                          Command="{Binding NewProjectCommand}"/>
                <MenuItem Header="開く(_O)" InputGestureText="Ctrl+O"
                          Command="{Binding OpenProjectCommand}"/>
                <Separator/>
                <MenuItem Header="上書き保存(_S)" InputGestureText="Ctrl+S"
                          Command="{Binding SaveProjectCommand}"/>
                <MenuItem Header="別名保存(_A)" InputGestureText="Ctrl+Shift+S"
                          Command="{Binding SaveProjectAsCommand}"/>
                <Separator/>
                <MenuItem Header="終了(_X)" InputGestureText="Alt+F4"
                          Command="{Binding ExitCommand}"/>
            </MenuItem>

            <!-- 編集 -->
            <MenuItem Header="編集(_E)">
                <MenuItem Header="シーン追加(_T)" InputGestureText="Ctrl+T"
                          Command="{Binding AddSceneCommand}"/>
                <MenuItem Header="シーン削除(_D)" InputGestureText="Delete"
                          Command="{Binding RemoveSceneCommand}"/>
                <Separator/>
                <MenuItem Header="上へ(_U)" InputGestureText="Ctrl+Up"
                          Command="{Binding MoveSceneUpCommand}"/>
                <MenuItem Header="下へ(_W)" InputGestureText="Ctrl+Down"
                          Command="{Binding MoveSceneDownCommand}"/>
            </MenuItem>

            <!-- ヘルプ -->
            <MenuItem Header="ヘルプ(_H)">
                <MenuItem Header="チュートリアル(_T)" InputGestureText="F1"
                          Command="{Binding ShowTutorialCommand}"/>
                <MenuItem Header="FAQ(_Q)"
                          Command="{Binding ShowFaqCommand}"/>
                <Separator/>
                <MenuItem Header="ライセンス管理(_L)"
                          Command="{Binding ShowLicenseManagerCommand}"/>
                <MenuItem Header="ライセンス情報(_I)"
                          Command="{Binding ShowLicenseInfoCommand}"/>
                <MenuItem Header="InsightMovieについて(_A)"
                          Command="{Binding ShowAboutCommand}"/>
            </MenuItem>
        </Menu>

        <!-- ================================================================ -->
        <!-- C) Main Content (Left: Scene List | Right: Scene Editor)          -->
        <!-- ================================================================ -->
        <Grid Grid.Row="2" Margin="4,4,4,2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="180" MinWidth="140" MaxWidth="300"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Scene List -->
            <GroupBox Grid.Column="0" Header="シーン一覧" Padding="4">
                <DockPanel>
                    <!-- Bottom buttons -->
                    <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal"
                                HorizontalAlignment="Center" Margin="0,4,0,0">
                        <Button Content="＋追加"
                                Padding="4,2" Margin="1"
                                Command="{Binding AddSceneCommand}"
                                ToolTip="シーンを追加 (Ctrl+T)"/>
                        <Button Content="－削除"
                                Padding="4,2" Margin="1"
                                Command="{Binding RemoveSceneCommand}"
                                ToolTip="シーンを削除 (Delete)"/>
                        <Button Content="↑"
                                Padding="6,2" Margin="1"
                                Command="{Binding MoveSceneUpCommand}"
                                ToolTip="上へ移動 (Ctrl+Up)"/>
                        <Button Content="↓"
                                Padding="6,2" Margin="1"
                                Command="{Binding MoveSceneDownCommand}"
                                ToolTip="下へ移動 (Ctrl+Down)"/>
                    </StackPanel>

                    <!-- Scene ListBox -->
                    <ListBox x:Name="SceneListBox"
                             ItemsSource="{Binding SceneItems}"
                             SelectedIndex="{Binding SelectedSceneIndex}"
                             HorizontalContentAlignment="Stretch">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Label}"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </GroupBox>

            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1" Width="5"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          Background="{DynamicResource BorderDefault}"/>

            <!-- Right Panel: Scene Editor -->
            <GroupBox Grid.Column="2" Header="シーン編集" Padding="4">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="8">

                        <!-- Row 1: Media info -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="素材:" VerticalAlignment="Center"
                                       Margin="0,0,6,0"/>
                            <TextBlock Text="{Binding MediaName}"
                                       VerticalAlignment="Center" Foreground="{DynamicResource TextSecondary}"
                                       MinWidth="120" Margin="0,0,8,0"/>
                            <Button Content="選択"
                                    Padding="10,3" Margin="2"
                                    Command="{Binding SelectMediaCommand}"/>
                            <Button Content="クリア"
                                    Padding="10,3" Margin="2"
                                    Command="{Binding ClearMediaCommand}"/>
                        </StackPanel>

                        <!-- Row 2: Preview container + Narration TextBox -->
                        <Grid Margin="0,0,0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Preview container -->
                            <Border Grid.Column="0" Width="120" Height="180"
                                    Background="#1a1a2e" CornerRadius="2"
                                    Margin="0,0,8,0" ClipToBounds="True">
                                <Grid>
                                    <Image x:Name="PreviewImage" Stretch="Uniform"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"/>
                                    <!-- Subtitle overlay at bottom -->
                                    <Border VerticalAlignment="Bottom"
                                            Background="#80000000" Padding="4,2">
                                        <TextBlock Text="{Binding SubtitleText}"
                                                   Foreground="White"
                                                   FontSize="9" TextWrapping="Wrap"
                                                   TextAlignment="Center"
                                                   MaxWidth="112"/>
                                    </Border>
                                </Grid>
                            </Border>

                            <!-- Narration TextBox with placeholder -->
                            <Grid Grid.Column="1">
                                <TextBox x:Name="NarrationTextBox"
                                         Text="{Binding NarrationText, UpdateSourceTrigger=PropertyChanged}"
                                         TextWrapping="Wrap" AcceptsReturn="True"
                                         VerticalScrollBarVisibility="Auto"
                                         MinHeight="140"
                                         VerticalContentAlignment="Top"
                                         Padding="4"/>
                                <TextBlock Text="ここに話をさせる内容を入力してください。"
                                           Foreground="{DynamicResource TextPlaceholder}" FontStyle="Italic"
                                           IsHitTestVisible="False"
                                           Margin="8,6,0,0"
                                           VerticalAlignment="Top"
                                           Visibility="{Binding NarrationPlaceholderVisible, Converter={StaticResource BoolToVis}}"/>
                            </Grid>
                        </Grid>

                        <!-- Row 3: Speaker + Audio controls -->
                        <WrapPanel Margin="0,0,0,4">
                            <TextBlock Text="話者:" VerticalAlignment="Center"
                                       Margin="0,0,4,0"/>
                            <ComboBox MinWidth="180"
                                      Margin="0,0,12,0"
                                      ItemsSource="{Binding SceneSpeakers}"
                                      SelectedIndex="{Binding SelectedSceneSpeakerIndex}"
                                      DisplayMemberPath="DisplayName"/>

                            <CheckBox Content="動画音声を残す"
                                      IsChecked="{Binding KeepOriginalAudio}"
                                      VerticalAlignment="Center" Margin="0,0,12,0"/>

                            <Button Content="▶音声再生"
                                    Padding="8,3" Margin="2"
                                    Command="{Binding PreviewAudioCommand}"/>
                            <Button Content="■停止"
                                    Padding="8,3" Margin="2"
                                    Command="{Binding StopPreviewCommand}"/>

                            <TextBlock Text="速度:" VerticalAlignment="Center"
                                       Margin="8,0,4,0"/>
                            <ComboBox x:Name="SpeedComboBox" Width="60" SelectedIndex="0">
                                <ComboBoxItem Content="1x" Tag="1"/>
                                <ComboBoxItem Content="2x" Tag="2"/>
                                <ComboBoxItem Content="4x" Tag="4"/>
                            </ComboBox>
                        </WrapPanel>

                        <!-- Row 4: Subtitle TextBox -->
                        <StackPanel Margin="0,0,0,4">
                            <TextBlock Text="字幕:" Margin="0,0,0,4"/>
                            <Grid>
                                <TextBox Text="{Binding SubtitleText, UpdateSourceTrigger=PropertyChanged}"
                                         Padding="4" Height="28"
                                         VerticalContentAlignment="Center"
                                         IsEnabled="{Binding CanSubtitle}"/>
                                <TextBlock Text="{Binding SubtitlePlaceholder}"
                                           Foreground="{DynamicResource TextPlaceholder}" FontStyle="Italic"
                                           IsHitTestVisible="False"
                                           Margin="8,0,0,0"
                                           VerticalAlignment="Center"
                                           Visibility="{Binding SubtitlePlaceholderVisible, Converter={StaticResource BoolToVis}}"/>
                            </Grid>
                        </StackPanel>

                        <!-- Row 5: Subtitle style -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="字幕スタイル:" VerticalAlignment="Center"
                                       Margin="0,0,8,0"/>
                            <Border BorderBrush="{DynamicResource BorderDefault}" BorderThickness="1"
                                    CornerRadius="2" Padding="8,2" Margin="0,0,8,0"
                                    Background="#1a1a2e" MinWidth="40"
                                    VerticalAlignment="Center">
                                <TextBlock x:Name="StylePreviewLabel" Text="A"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="White"
                                           HorizontalAlignment="Center"/>
                            </Border>
                            <Button Content="選択..."
                                    Padding="10,3" Margin="2"
                                    Command="{Binding OpenStyleDialogCommand}"
                                    IsEnabled="{Binding CanSubtitleStyle}"/>
                        </StackPanel>

                        <!-- Row 6: Duration mode -->
                        <StackPanel Margin="0,0,0,4">
                            <TextBlock Text="シーンの長さ:" Margin="0,0,0,4"/>
                            <StackPanel Orientation="Horizontal">
                                <RadioButton Content="自動"
                                             IsChecked="{Binding IsAutoDuration}"
                                             VerticalAlignment="Center" Margin="0,0,16,0"
                                             GroupName="DurationMode"/>
                                <RadioButton Content="固定"
                                             IsChecked="{Binding IsFixedDuration}"
                                             VerticalAlignment="Center" Margin="0,0,8,0"
                                             GroupName="DurationMode"/>
                                <TextBox Text="{Binding DurationSeconds, UpdateSourceTrigger=PropertyChanged}"
                                         Width="60"
                                         VerticalContentAlignment="Center"
                                         TextAlignment="Center" Margin="0,0,4,0"
                                         IsEnabled="{Binding IsFixedDuration}"/>
                                <TextBlock Text="秒 (0.1～60)" VerticalAlignment="Center"
                                           Foreground="{DynamicResource TextTertiary}" FontSize="11"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Row 7: Transition -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                            <TextBlock Text="トランジション:" VerticalAlignment="Center"
                                       Margin="0,0,8,0"/>
                            <ComboBox Width="160"
                                      Margin="0,0,12,0"
                                      ItemsSource="{Binding TransitionDisplayNames}"
                                      SelectedIndex="{Binding SelectedTransitionIndex}"
                                      IsEnabled="{Binding CanTransition}"/>
                            <TextBlock Text="時間:" VerticalAlignment="Center"
                                       Margin="0,0,4,0"/>
                            <TextBox Text="{Binding TransitionDuration, UpdateSourceTrigger=PropertyChanged}"
                                     Width="60"
                                     VerticalContentAlignment="Center"
                                     TextAlignment="Center" Margin="0,0,4,0"
                                     IsEnabled="{Binding CanTransition}"/>
                            <TextBlock Text="秒 (0.2～2.0)" VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextTertiary}" FontSize="11"/>
                        </StackPanel>

                        <!-- Row 8: Info label -->
                        <TextBlock Text="「自動」の場合、ナレーション音声の長さに応じてシーンの長さが自動的に決まります。素材がない場合は黒背景が使用されます。"
                                   TextWrapping="Wrap" Foreground="{DynamicResource TextTertiary}"
                                   FontSize="11" Margin="0,0,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </GroupBox>
        </Grid>

        <!-- ================================================================ -->
        <!-- D) Export Panel                                                   -->
        <!-- ================================================================ -->
        <GroupBox Grid.Row="3" Header="書き出し設定" Margin="4,2,4,2" Padding="4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Export settings controls -->
                <WrapPanel Grid.Column="0" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="話者:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <ComboBox MinWidth="200"
                                  ItemsSource="{Binding ExportSpeakers}"
                                  SelectedIndex="{Binding SelectedExportSpeakerIndex}"
                                  DisplayMemberPath="DisplayName"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="解像度:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <ComboBox Width="180"
                                  SelectedIndex="{Binding SelectedResolutionIndex}">
                            <ComboBoxItem Content="1080x1920 (縦動画)" Tag="1080x1920"/>
                            <ComboBoxItem Content="1920x1080 (横動画)" Tag="1920x1080"/>
                        </ComboBox>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="FPS:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBox Text="{Binding FpsText, UpdateSourceTrigger=PropertyChanged}"
                                 Width="50"
                                 VerticalContentAlignment="Center" TextAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="{Binding BgmStatusText}"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextTertiary}"
                                   Margin="0,0,6,0"/>
                        <Button Content="BGM設定..."
                                Padding="8,3"
                                Command="{Binding BgmSettingsCommand}"/>
                    </StackPanel>
                </WrapPanel>

                <!-- Right: Export button -->
                <Button Grid.Column="1"
                        Content="動画を書き出し"
                        Width="150" Height="44"
                        FontSize="12" FontWeight="Bold"
                        Style="{DynamicResource PrimaryButton}"
                        Command="{Binding ExportVideoCommand}"
                        ToolTip="プロジェクトを動画ファイルとして書き出します"/>
            </Grid>
        </GroupBox>

        <!-- ================================================================ -->
        <!-- E) ProgressBar                                                    -->
        <!-- ================================================================ -->
        <ProgressBar Grid.Row="4"
                     Height="6" Margin="4,0,4,2"
                     Visibility="{Binding ExportProgressVisible, Converter={StaticResource BoolToVis}}"
                     IsIndeterminate="True"/>

        <!-- ================================================================ -->
        <!-- F) Log Area                                                       -->
        <!-- ================================================================ -->
        <DockPanel Grid.Row="5" Height="120" Margin="4,0,4,4">
            <TextBlock Text="ログ:" DockPanel.Dock="Top" FontSize="11"
                       Foreground="{DynamicResource TextSecondary}" Margin="0,0,0,2"/>
            <TextBox x:Name="LogTextBox" IsReadOnly="True"
                     VerticalScrollBarVisibility="Auto"
                     HorizontalScrollBarVisibility="Auto"
                     TextWrapping="NoWrap" FontSize="11"
                     FontFamily="Consolas, MS Gothic"
                     Background="{DynamicResource BgSecondary}"/>
        </DockPanel>

        <!-- Hidden MediaElement for audio preview playback -->
        <MediaElement x:Name="AudioPlayer"
                      Grid.Row="0"
                      LoadedBehavior="Manual"
                      UnloadedBehavior="Stop"
                      Visibility="Collapsed"
                      MediaEnded="AudioPlayer_MediaEnded"/>
    </Grid>
</Window>
