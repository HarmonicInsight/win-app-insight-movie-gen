<Window x:Class="InsightMovie.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="InsightMovie - 新規プロジェクト"
        MinWidth="1100" MinHeight="750"
        Width="1300" Height="950"
        WindowStartupLocation="CenterScreen"
        PreviewKeyDown="Window_PreviewKeyDown"
        Closing="Window_Closing">

    <!-- Command Bindings for standard commands -->
    <Window.CommandBindings>
        <CommandBinding Command="ApplicationCommands.New" Executed="NewProject_Executed"/>
        <CommandBinding Command="ApplicationCommands.Open" Executed="OpenProject_Executed"/>
        <CommandBinding Command="ApplicationCommands.Save" Executed="SaveProject_Executed"/>
    </Window.CommandBindings>

    <Window.InputBindings>
        <KeyBinding Key="N" Modifiers="Control" Command="ApplicationCommands.New"/>
        <KeyBinding Key="O" Modifiers="Control" Command="ApplicationCommands.Open"/>
        <KeyBinding Key="S" Modifiers="Control" Command="ApplicationCommands.Save"/>
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Row 0: Header bar -->
            <RowDefinition Height="Auto"/>  <!-- Row 1: Menu bar -->
            <RowDefinition Height="*"/>     <!-- Row 2: Main content -->
            <RowDefinition Height="Auto"/>  <!-- Row 3: Export panel -->
            <RowDefinition Height="Auto"/>  <!-- Row 4: ProgressBar -->
            <RowDefinition Height="Auto"/>  <!-- Row 5: Log area -->
        </Grid.RowDefinitions>

        <!-- ================================================================ -->
        <!-- A) Header Bar                                                    -->
        <!-- ================================================================ -->
        <Border Grid.Row="0" Background="#F0F0F0" Padding="10,6" BorderBrush="#D0D0D0" BorderThickness="0,0,0,1">
            <DockPanel>
                <!-- Left: App title -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="InsightMovie" FontSize="18" FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock Text="v1.0.0" Foreground="#888888" FontSize="11"
                               VerticalAlignment="Bottom" Margin="8,0,0,4"/>
                </StackPanel>

                <!-- Right: Status label -->
                <Border DockPanel.Dock="Right" Background="#E8E8E8" CornerRadius="3"
                        Padding="8,3" Margin="4,0,0,0" VerticalAlignment="Center">
                    <TextBlock x:Name="StatusLabel"
                               Text="VOICEVOX: ✓接続OK • ffmpeg: ✓検出OK"
                               Foreground="#555555" FontSize="11"/>
                </Border>

                <!-- Center/Right: Action buttons -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right"
                            VerticalAlignment="Center" Margin="8,0">
                    <Button x:Name="NewProjectButton" Content="新規"
                            Padding="10,4" Margin="2" Click="NewProject_Click"/>
                    <Button x:Name="OpenProjectButton" Content="設定ファイルを開く"
                            Padding="10,4" Margin="2" Click="OpenProject_Click"/>
                    <Button x:Name="SaveProjectButton" Content="設定を上書き保存"
                            Padding="10,4" Margin="2" Click="SaveProject_Click"/>
                    <Button x:Name="SaveProjectAsButton" Content="設定を別名で保存"
                            Padding="10,4" Margin="2" Click="SaveProjectAs_Click"/>
                    <Button x:Name="ImportPptxButton" Content="PPTX取込"
                            Padding="10,4" Margin="2"
                            Background="#4CAF50" Foreground="White"
                            Click="ImportPptx_Click"/>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- ================================================================ -->
        <!-- B) Menu Bar                                                       -->
        <!-- ================================================================ -->
        <Menu Grid.Row="1">
            <!-- ファイル -->
            <MenuItem Header="ファイル(_F)">
                <MenuItem Header="新規(_N)" InputGestureText="Ctrl+N" Click="NewProject_Click"/>
                <MenuItem Header="開く(_O)" InputGestureText="Ctrl+O" Click="OpenProject_Click"/>
                <Separator/>
                <MenuItem Header="上書き保存(_S)" InputGestureText="Ctrl+S" Click="SaveProject_Click"/>
                <MenuItem Header="別名保存(_A)" InputGestureText="Ctrl+Shift+S" Click="SaveProjectAs_Click"/>
                <Separator/>
                <MenuItem Header="終了(_X)" InputGestureText="Alt+F4" Click="ExitApp_Click"/>
            </MenuItem>

            <!-- 編集 -->
            <MenuItem Header="編集(_E)">
                <MenuItem x:Name="MenuAddScene" Header="シーン追加(_T)"
                          InputGestureText="Ctrl+T" Click="AddScene_Click"/>
                <MenuItem x:Name="MenuRemoveScene" Header="シーン削除(_D)"
                          InputGestureText="Delete" Click="RemoveScene_Click"/>
                <Separator/>
                <MenuItem x:Name="MenuMoveUp" Header="上へ(_U)"
                          InputGestureText="Ctrl+Up" Click="MoveSceneUp_Click"/>
                <MenuItem x:Name="MenuMoveDown" Header="下へ(_W)"
                          InputGestureText="Ctrl+Down" Click="MoveSceneDown_Click"/>
            </MenuItem>

            <!-- ヘルプ -->
            <MenuItem Header="ヘルプ(_H)">
                <MenuItem Header="チュートリアル(_T)" InputGestureText="F1" Click="ShowTutorial_Click"/>
                <MenuItem Header="FAQ(_Q)" Click="ShowFaq_Click"/>
                <Separator/>
                <MenuItem Header="ライセンス管理(_L)" Click="ShowLicenseManager_Click"/>
                <MenuItem Header="ライセンス情報(_I)" Click="ShowLicense_Click"/>
                <MenuItem Header="InsightMovieについて(_A)" Click="ShowAbout_Click"/>
            </MenuItem>
        </Menu>

        <!-- ================================================================ -->
        <!-- C) Main Content (Left: Scene List | Right: Scene Editor)          -->
        <!-- ================================================================ -->
        <Grid Grid.Row="2" Margin="4,4,4,2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="160" MinWidth="120" MaxWidth="300"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Scene List -->
            <GroupBox Grid.Column="0" Header="シーン一覧" Padding="4">
                <DockPanel>
                    <!-- Bottom buttons -->
                    <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal"
                                HorizontalAlignment="Center" Margin="0,4,0,0">
                        <Button x:Name="AddSceneButton" Content="＋追加"
                                Padding="6,2" Margin="2" Click="AddScene_Click"
                                ToolTip="シーンを追加 (Ctrl+T)"/>
                        <Button x:Name="RemoveSceneButton" Content="－削除"
                                Padding="6,2" Margin="2" Click="RemoveScene_Click"
                                ToolTip="シーンを削除 (Delete)"/>
                        <Button x:Name="MoveUpButton" Content="↑"
                                Padding="8,2" Margin="2" Click="MoveSceneUp_Click"
                                ToolTip="上へ移動 (Ctrl+Up)"/>
                        <Button x:Name="MoveDownButton" Content="↓"
                                Padding="8,2" Margin="2" Click="MoveSceneDown_Click"
                                ToolTip="下へ移動 (Ctrl+Down)"/>
                    </StackPanel>

                    <!-- Scene ListBox -->
                    <ListBox x:Name="SceneListBox"
                             SelectionChanged="SceneListBox_SelectionChanged"
                             HorizontalContentAlignment="Stretch"/>
                </DockPanel>
            </GroupBox>

            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1" Width="5"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          Background="#D0D0D0"/>

            <!-- Right Panel: Scene Editor -->
            <GroupBox Grid.Column="2" Header="シーン編集" Padding="4">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="8">

                        <!-- Row 1: Media info -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="素材:" VerticalAlignment="Center"
                                       FontWeight="SemiBold" Margin="0,0,6,0"/>
                            <TextBlock x:Name="MediaNameLabel" Text="（未選択）"
                                       VerticalAlignment="Center" Foreground="#666666"
                                       MinWidth="120" Margin="0,0,8,0"/>
                            <Button x:Name="SelectMediaButton" Content="選択"
                                    Padding="10,3" Margin="2" Click="SelectMedia_Click"/>
                            <Button x:Name="ClearMediaButton" Content="クリア"
                                    Padding="10,3" Margin="2" Click="ClearMedia_Click"/>
                        </StackPanel>

                        <!-- Row 2: Preview container + Narration TextBox -->
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Preview container -->
                            <Border Grid.Column="0" Width="120" Height="180"
                                    Background="#1a1a2e" CornerRadius="2"
                                    Margin="0,0,8,0" ClipToBounds="True">
                                <Grid>
                                    <Image x:Name="PreviewImage" Stretch="UniformToFill"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"/>
                                    <!-- Subtitle overlay at bottom -->
                                    <Border VerticalAlignment="Bottom"
                                            Background="#80000000" Padding="4,2">
                                        <TextBlock x:Name="SubtitleOverlayLabel"
                                                   Text="" Foreground="White"
                                                   FontSize="9" TextWrapping="Wrap"
                                                   TextAlignment="Center"
                                                   MaxWidth="112"/>
                                    </Border>
                                </Grid>
                            </Border>

                            <!-- Narration TextBox with placeholder -->
                            <Grid Grid.Column="1">
                                <TextBox x:Name="NarrationTextBox"
                                         TextWrapping="Wrap" AcceptsReturn="True"
                                         VerticalScrollBarVisibility="Auto"
                                         MinHeight="140"
                                         VerticalContentAlignment="Top"
                                         Padding="4"
                                         TextChanged="OnNarrationChanged"/>
                                <TextBlock x:Name="NarrationPlaceholder"
                                           Text="ここに話をさせる内容を入力してください。"
                                           Foreground="#999999" FontStyle="Italic"
                                           IsHitTestVisible="False"
                                           Margin="8,6,0,0"
                                           VerticalAlignment="Top"/>
                            </Grid>
                        </Grid>

                        <!-- Row 3: Speaker + Audio controls -->
                        <WrapPanel Margin="0,0,0,8">
                            <TextBlock Text="話者:" VerticalAlignment="Center"
                                       Margin="0,0,4,0"/>
                            <ComboBox x:Name="SceneSpeakerComboBox" Width="180"
                                      Margin="0,0,12,0"
                                      SelectionChanged="OnSceneSpeakerChanged"/>

                            <CheckBox x:Name="KeepAudioCheckBox" Content="動画音声を残す"
                                      VerticalAlignment="Center" Margin="0,0,12,0"
                                      Checked="OnKeepAudioChanged"
                                      Unchecked="OnKeepAudioChanged"/>

                            <Button x:Name="PlayAudioButton" Content="▶音声再生"
                                    Padding="8,3" Margin="2" Click="PreviewAudio_Click"/>
                            <Button x:Name="StopAudioButton" Content="■停止"
                                    Padding="8,3" Margin="2" Click="StopPreview_Click"/>

                            <TextBlock Text="速度:" VerticalAlignment="Center"
                                       Margin="8,0,4,0"/>
                            <ComboBox x:Name="SpeedComboBox" Width="60" SelectedIndex="0">
                                <ComboBoxItem Content="1x" Tag="1"/>
                                <ComboBoxItem Content="2x" Tag="2"/>
                                <ComboBoxItem Content="4x" Tag="4"/>
                            </ComboBox>
                        </WrapPanel>

                        <!-- Row 4: Subtitle TextBox -->
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="字幕:" FontWeight="SemiBold" Margin="0,0,0,4"/>
                            <Grid>
                                <TextBox x:Name="SubtitleTextBox"
                                         Padding="4" Height="28"
                                         VerticalContentAlignment="Center"
                                         TextChanged="OnSubtitleChanged"/>
                                <TextBlock x:Name="SubtitlePlaceholder"
                                           Text="画面下部に表示される字幕"
                                           Foreground="#999999" FontStyle="Italic"
                                           IsHitTestVisible="False"
                                           Margin="8,0,0,0"
                                           VerticalAlignment="Center"/>
                            </Grid>
                        </StackPanel>

                        <!-- Row 5: Subtitle style -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="字幕スタイル:" VerticalAlignment="Center"
                                       Margin="0,0,8,0"/>
                            <Border BorderBrush="#CCCCCC" BorderThickness="1"
                                    CornerRadius="2" Padding="8,2" Margin="0,0,8,0"
                                    Background="#1a1a2e" MinWidth="40"
                                    VerticalAlignment="Center">
                                <TextBlock x:Name="StylePreviewLabel" Text="A"
                                           FontSize="16" FontWeight="Bold"
                                           Foreground="White"
                                           HorizontalAlignment="Center"/>
                            </Border>
                            <Button x:Name="SelectStyleButton" Content="選択..."
                                    Padding="10,3" Margin="2"
                                    Click="OpenStyleDialog_Click"/>
                        </StackPanel>

                        <!-- Row 6: Duration mode -->
                        <StackPanel Margin="0,0,0,8">
                            <TextBlock Text="シーンの長さ:" FontWeight="SemiBold" Margin="0,0,0,4"/>
                            <StackPanel Orientation="Horizontal">
                                <RadioButton x:Name="AutoDurationRadio" Content="自動"
                                             VerticalAlignment="Center" Margin="0,0,16,0"
                                             IsChecked="True" GroupName="DurationMode"
                                             Checked="OnDurationModeChanged"/>
                                <RadioButton x:Name="FixedDurationRadio" Content="固定"
                                             VerticalAlignment="Center" Margin="0,0,8,0"
                                             GroupName="DurationMode"
                                             Checked="OnDurationModeChanged"/>
                                <TextBox x:Name="DurationSecondsTextBox"
                                         Text="3.0" Width="60"
                                         VerticalContentAlignment="Center"
                                         TextAlignment="Center" Margin="0,0,4,0"
                                         IsEnabled="{Binding IsChecked, ElementName=FixedDurationRadio}"
                                         TextChanged="OnDurationSecondsChanged"/>
                                <TextBlock Text="秒 (0.1～60)" VerticalAlignment="Center"
                                           Foreground="#888888" FontSize="11"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Row 7: Transition -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="トランジション:" VerticalAlignment="Center"
                                       FontWeight="SemiBold" Margin="0,0,8,0"/>
                            <ComboBox x:Name="TransitionComboBox" Width="160"
                                      Margin="0,0,12,0"
                                      SelectionChanged="OnTransitionChanged"/>
                            <TextBlock Text="時間:" VerticalAlignment="Center"
                                       Margin="0,0,4,0"/>
                            <TextBox x:Name="TransitionDurationTextBox"
                                     Text="0.5" Width="50"
                                     VerticalContentAlignment="Center"
                                     TextAlignment="Center" Margin="0,0,4,0"
                                     TextChanged="OnTransitionDurationChanged"/>
                            <TextBlock Text="秒 (0.2～2.0)" VerticalAlignment="Center"
                                       Foreground="#888888" FontSize="11"/>
                        </StackPanel>

                        <!-- Row 8: Info label -->
                        <TextBlock x:Name="SceneInfoLabel"
                                   Text="「自動」の場合、ナレーション音声の長さに応じてシーンの長さが自動的に決まります。素材がない場合は黒背景が使用されます。"
                                   TextWrapping="Wrap" Foreground="#888888"
                                   FontSize="11" Margin="0,4,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </GroupBox>
        </Grid>

        <!-- ================================================================ -->
        <!-- D) Export Panel                                                   -->
        <!-- ================================================================ -->
        <GroupBox Grid.Row="3" Header="書き出し設定" Margin="4,2,4,2" Padding="4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: Export settings controls -->
                <WrapPanel Grid.Column="0" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="話者:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <ComboBox x:Name="ExportSpeakerComboBox" Width="200"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="解像度:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <ComboBox x:Name="ResolutionComboBox" Width="180" SelectedIndex="0">
                            <ComboBoxItem Content="1080x1920 (縦動画)" Tag="1080x1920"/>
                            <ComboBoxItem Content="1920x1080 (横動画)" Tag="1920x1080"/>
                        </ComboBox>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock Text="FPS:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBox x:Name="FpsTextBox" Text="30" Width="45"
                                 VerticalContentAlignment="Center" TextAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Margin="0,2,12,2">
                        <TextBlock x:Name="BgmStatusLabel" Text="BGM: 未設定"
                                   VerticalAlignment="Center" Foreground="#888888"
                                   Margin="0,0,6,0"/>
                        <Button x:Name="BgmSettingsButton" Content="BGM設定..."
                                Padding="8,3" Click="BgmSettings_Click"/>
                    </StackPanel>
                </WrapPanel>

                <!-- Right: Export button -->
                <Button x:Name="ExportButton" Grid.Column="1"
                        Content="動画を書き出し"
                        Width="150" Height="44"
                        FontSize="12" FontWeight="Bold"
                        Background="#4CAF50" Foreground="White"
                        Click="ExportVideo_Click"
                        ToolTip="プロジェクトを動画ファイルとして書き出します"/>
            </Grid>
        </GroupBox>

        <!-- ================================================================ -->
        <!-- E) ProgressBar                                                    -->
        <!-- ================================================================ -->
        <ProgressBar x:Name="ExportProgressBar" Grid.Row="4"
                     Height="6" Margin="4,0,4,2"
                     Visibility="Collapsed"
                     IsIndeterminate="True"/>

        <!-- ================================================================ -->
        <!-- F) Log Area                                                       -->
        <!-- ================================================================ -->
        <DockPanel Grid.Row="5" Height="60" Margin="4,0,4,4">
            <TextBlock Text="ログ:" DockPanel.Dock="Top" FontSize="11"
                       Foreground="#666666" Margin="0,0,0,2"/>
            <TextBox x:Name="LogTextBox" IsReadOnly="True"
                     VerticalScrollBarVisibility="Auto"
                     HorizontalScrollBarVisibility="Auto"
                     TextWrapping="NoWrap" FontSize="11"
                     FontFamily="Consolas, MS Gothic"
                     Background="#FAFAFA"/>
        </DockPanel>

        <!-- Hidden MediaElement for audio preview playback -->
        <MediaElement x:Name="AudioPlayer"
                      Grid.Row="0"
                      LoadedBehavior="Manual"
                      UnloadedBehavior="Stop"
                      Visibility="Collapsed"
                      MediaEnded="AudioPlayer_MediaEnded"/>
    </Grid>
</Window>
